#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR

set -e

source $(dirname $0)/../scripts/functions

BUILD_DIR=$1
echo "Info: BUILD_DIR=$BUILD_DIR"
CACHE_DIR=$2
echo "Info: CACHE_DIR=$CACHE_DIR"

[ -z $GHC_VERSION ] && echo "Error: please set GHC_VERSION in environment" && exit 1

## CHECK BUILDPACK_GHC_BASE_URL is set
if [ -z ${BUILDPACK_GHC_BASE_URL} ]; then
  echo "Error: please set BUILDPACK_GHC_BASE_URL";
  exit 1;
else
  mkdir -p ${CACHE_DIR};
  pushd ${CACHE_DIR};
  URL=${BUILDPACK_GHC_BASE_URL}/ghc-heroku-${GHC_VERSION}.tar.bz2;
  echo "Info: Downloading ${URL}"
  curl -O ${URL};
  tar jxvf ghc-heroku-${GHC_VERSION}.tar.bz2;
  cabal update;
  cabal install cabal cabal-install;
  popd;

  PATH=${CACHE_DIR}/ghc/bin:$PATH;

  pushd ${BUILD_DIR};
  cabal install;
  popd;
fi;
